<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenAI API Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; }
        .status { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <h1>OpenAI API Test</h1>
    <div id="status"></div>
    <div class="mt-4">
        <button class="btn btn-primary" onclick="testOpenAI()">Test OpenAI API</button>
        <button class="btn btn-secondary" onclick="testTripGeneration()">Test Trip Generation</button>
    </div>
    <div class="mt-4">
        <h4>Test Results:</h4>
        <div id="results" class="border p-3 bg-light"></div>
    </div>

    <script>
        function addStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            const statusElement = document.createElement('div');
            statusElement.className = `status ${type}`;
            statusElement.innerHTML = `<strong>${new Date().toLocaleTimeString()}:</strong> ${message}`;
            statusDiv.appendChild(statusElement);
            console.log(`${type.toUpperCase()}: ${message}`);
        }

        async function testOpenAI() {
            addStatus('Testing OpenAI API...', 'info');

            try {
                const response = await fetch('/test_openai_api', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.content
                    },
                    body: JSON.stringify({
                        prompt: 'Create a 2-day trip to Manali for 2 adults with budget â‚¹10,000'
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    addStatus('OpenAI API test successful!', 'success');
                    document.getElementById('results').innerHTML = `
                        <h5>API Response:</h5>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                } else {
                    addStatus(`OpenAI API test failed: ${data.error || 'Unknown error'}`, 'error');
                    document.getElementById('results').innerHTML = `
                        <h5>Error:</h5>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                }
            } catch (error) {
                addStatus(`Test failed: ${error.message}`, 'error');
            }
        }

        async function testTripGeneration() {
            addStatus('Testing trip generation...', 'info');

            try {
                const response = await fetch('/planner', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.content
                    },
                    body: JSON.stringify({
                        destination: 'Manali',
                        duration: '2',
                        adults: '2',
                        children: '0',
                        infants: '0',
                        budget: '10000',
                        currency: 'INR',
                        trip_type: ['adventure'],
                        travel_pace: 'moderate',
                        accommodation: 'midrange',
                        interests: ['hiking', 'adventure'],
                        dietary: ['vegetarian'],
                        avoid: '',
                        special_requirements: '',
                        notes: ''
                    })
                });

                if (response.redirected) {
                    addStatus('Trip generation successful - redirected to trip page', 'success');
                    window.location.href = response.url;
                } else {
                    const data = await response.json();
                    addStatus(`Trip generation failed: ${data.error || 'Unknown error'}`, 'error');
                    document.getElementById('results').innerHTML = `
                        <h5>Error:</h5>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                }
            } catch (error) {
                addStatus(`Test failed: ${error.message}`, 'error');
            }
        }

        // Add CSRF token meta tag
        document.addEventListener('DOMContentLoaded', function() {
            if (!document.querySelector('meta[name="csrf-token"]')) {
                const meta = document.createElement('meta');
                meta.name = 'csrf-token';
                meta.content = document.querySelector('input[name="authenticity_token"]')?.value || '';
                document.head.appendChild(meta);
            }
        });
    </script>
</body>
</html>
