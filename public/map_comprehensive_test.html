<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Map Comprehensive Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .debug { background: #f8f9fa; color: #6c757d; }
        #map { height: 400px; width: 100%; border: 2px solid #ddd; position: relative; }
        .map-loading {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .mapboxgl-canvas { z-index: 1; }
    </style>
</head>
<body>
    <h1>Map Comprehensive Test</h1>

    <div id="results"></div>

    <div class="mt-4">
        <button class="btn btn-primary" onclick="runComprehensiveTest()">Run Comprehensive Test</button>
        <button class="btn btn-secondary" onclick="location.reload()">Reload</button>
        <button class="btn btn-info" onclick="checkMapVisibility()">Check Map Visibility</button>
    </div>

    <div class="mt-4">
        <h4>Map Test Area:</h4>
        <div id="map">
            <div class="map-loading" id="loadingSpinner">
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3 text-muted">Loading Map...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        function addResult(message, type = 'info') {
            const resultsDiv = document.getElementById('results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${type}`;
            resultDiv.textContent = message;
            resultsDiv.appendChild(resultDiv);
        }

        function checkMapVisibility() {
            const mapContainer = document.getElementById('map');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const mapboxCanvas = document.querySelector('.mapboxgl-canvas');

            addResult('=== Map Visibility Check ===', 'debug');
            addResult(`Map container exists: ${!!mapContainer}`, 'info');
            addResult(`Loading spinner visible: ${loadingSpinner.style.display !== 'none'}`, 'info');
            addResult(`Mapbox canvas exists: ${!!mapboxCanvas}`, 'info');

            if (mapboxCanvas) {
                addResult(`Canvas width: ${mapboxCanvas.width}`, 'debug');
                addResult(`Canvas height: ${mapboxCanvas.height}`, 'debug');
                addResult(`Canvas style display: ${mapboxCanvas.style.display}`, 'debug');
            }

            // Check if map is actually visible
            if (mapboxCanvas && mapboxCanvas.width > 0 && mapboxCanvas.height > 0) {
                addResult('✅ Map is visible and has content', 'success');
            } else if (mapboxCanvas) {
                addResult('⚠️ Map canvas exists but may be empty', 'error');
            } else {
                addResult('❌ Map canvas not found', 'error');
            }
        }

        function runComprehensiveTest() {
            document.getElementById('results').innerHTML = '';
            addResult('Starting comprehensive map test...', 'info');

            // Test 1: Check if we can access the actual map page
            fetch('/explore/map')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.text();
                })
                .then(html => {
                    addResult('✅ Map page accessible', 'success');

                    // Test 2: Check for correct token
                    if (html.includes('pk.eyJ1IjoiZ3lhbnNpbmdoMTgiLCJhIjoiY21ic3MxZ3BiMGE2cDJtc2lpN3pnNXN6NCJ9.4UhCbEv0elEp6VG8OrtEgg')) {
                        addResult('✅ Correct Mapbox token found', 'success');
                    } else {
                        addResult('❌ Correct Mapbox token not found', 'error');
                    }

                    // Test 3: Check for MAPBOX_TOKEN variable
                    if (html.includes('MAPBOX_TOKEN')) {
                        addResult('✅ MAPBOX_TOKEN variable found', 'success');
                    } else {
                        addResult('❌ MAPBOX_TOKEN variable not found', 'error');
                    }

                    // Test 4: Check for initialization function
                    if (html.includes('initializeMapWithDebug')) {
                        addResult('✅ Map initialization function found', 'success');
                    } else {
                        addResult('❌ Map initialization function not found', 'error');
                    }

                    // Test 5: Check for loading spinner
                    if (html.includes('map-loading')) {
                        addResult('✅ Loading spinner found', 'success');
                    } else {
                        addResult('❌ Loading spinner not found', 'error');
                    }

                })
                .catch(error => {
                    addResult(`❌ Error testing map page: ${error.message}`, 'error');
                });

            // Test 6: Try to load map directly
            setTimeout(() => {
                addResult('Testing direct map loading...', 'info');

                // Load Mapbox CSS
                const cssLink = document.createElement('link');
                cssLink.rel = 'stylesheet';
                cssLink.href = 'https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css';
                cssLink.onload = () => {
                    addResult('✅ Mapbox CSS loaded', 'success');

                    // Load Mapbox JS
                    const script = document.createElement('script');
                    script.src = 'https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js';
                    script.onload = () => {
                        addResult('✅ Mapbox JS loaded', 'success');

                        if (typeof mapboxgl !== 'undefined') {
                            addResult('✅ mapboxgl object available', 'success');

                            try {
                                const token = 'pk.eyJ1IjoiZ3lhbnNpbmdoMTgiLCJhIjoiY21ic3MxZ3BiMGE2cDJtc2lpN3pnNXN6NCJ9.4UhCbEv0elEp6VG8OrtEgg';
                                mapboxgl.accessToken = token;
                                addResult('✅ Access token set', 'success');

                                const map = new mapboxgl.Map({
                                    container: 'map',
                                    style: 'mapbox://styles/mapbox/streets-v11',
                                    center: [78.9629, 20.5937],
                                    zoom: 4
                                });

                                addResult('✅ Map instance created', 'success');

                                map.on('load', () => {
                                    addResult('✅ Map loaded successfully!', 'success');
                                    // Hide loading spinner
                                    const loadingSpinner = document.getElementById('loadingSpinner');
                                    if (loadingSpinner) {
                                        loadingSpinner.style.display = 'none';
                                        addResult('✅ Loading spinner hidden', 'success');
                                    }

                                    // Check map visibility after a delay
                                    setTimeout(() => {
                                        checkMapVisibility();
                                    }, 2000);
                                });

                                map.on('error', (e) => {
                                    addResult(`❌ Map error: ${e.error}`, 'error');
                                });

                                map.on('render', () => {
                                    addResult('🔄 Map rendering...', 'debug');
                                });

                            } catch (error) {
                                addResult(`❌ Error creating map: ${error.message}`, 'error');
                            }
                        } else {
                            addResult('❌ mapboxgl object not available', 'error');
                        }
                    };
                    script.onerror = () => {
                        addResult('❌ Failed to load Mapbox JS', 'error');
                    };
                    document.head.appendChild(script);
                };
                cssLink.onerror = () => {
                    addResult('❌ Failed to load Mapbox CSS', 'error');
                };
                document.head.appendChild(cssLink);
            }, 1000);
        }

        // Auto-test on page load
        window.addEventListener('load', () => {
            addResult('Page loaded, ready for comprehensive testing...', 'info');
        });
    </script>
</body>
</html>
