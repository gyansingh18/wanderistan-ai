<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Map Final Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        #map { height: 400px; width: 100%; border: 2px solid #ddd; }
    </style>
</head>
<body>
    <h1>Map Final Test</h1>

    <div id="results"></div>

    <div class="mt-4">
        <button class="btn btn-primary" onclick="testMapFinal()">Test Map Loading</button>
        <button class="btn btn-secondary" onclick="location.reload()">Reload</button>
    </div>

    <div class="mt-4">
        <h4>Map Test Area:</h4>
        <div id="map">
            <div class="text-center p-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3 text-muted">Loading Map...</p>
            </div>
        </div>
    </div>

    <script>
        function addResult(message, type = 'info') {
            const resultsDiv = document.getElementById('results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${type}`;
            resultDiv.textContent = message;
            resultsDiv.appendChild(resultDiv);
        }

        function testMapFinal() {
            addResult('Testing final map loading...', 'info');

            // Test 1: Check if map page loads
            fetch('/explore/map')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.text();
                })
                .then(html => {
                    addResult('✅ Map page accessible', 'success');

                    // Test 2: Check for correct token
                    if (html.includes('pk.eyJ1IjoiZ3lhbnNpbmdoMTgiLCJhIjoiY21ic3MxZ3BiMGE2cDJtc2lpN3pnNXN6NCJ9.4UhCbEv0elEp6VG8OrtEgg')) {
                        addResult('✅ Correct Mapbox token found', 'success');
                    } else {
                        addResult('❌ Correct Mapbox token not found', 'error');
                    }

                    // Test 3: Check for MAPBOX_TOKEN variable
                    if (html.includes('MAPBOX_TOKEN')) {
                        addResult('✅ MAPBOX_TOKEN variable found', 'success');
                    } else {
                        addResult('❌ MAPBOX_TOKEN variable not found', 'error');
                    }

                    // Test 4: Check for initialization function
                    if (html.includes('initializeMapWithDebug')) {
                        addResult('✅ Map initialization function found', 'success');
                    } else {
                        addResult('❌ Map initialization function not found', 'error');
                    }

                })
                .catch(error => {
                    addResult(`❌ Error testing map: ${error.message}`, 'error');
                });
        }

        // Test actual map loading
        function testActualMap() {
            addResult('Testing actual map loading...', 'info');

            // Load Mapbox CSS
            const cssLink = document.createElement('link');
            cssLink.rel = 'stylesheet';
            cssLink.href = 'https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css';
            document.head.appendChild(cssLink);

            // Load Mapbox JS
            const script = document.createElement('script');
            script.src = 'https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js';
            script.onload = () => {
                addResult('✅ Mapbox GL JS loaded', 'success');

                // Test map creation with correct token
                try {
                    mapboxgl.accessToken = 'pk.eyJ1IjoiZ3lhbnNpbmdoMTgiLCJhIjoiY21ic3MxZ3BiMGE2cDJtc2lpN3pnNXN6NCJ9.4UhCbEv0elEp6VG8OrtEgg';

                    const map = new mapboxgl.Map({
                        container: 'map',
                        style: 'mapbox://styles/mapbox/streets-v11',
                        center: [78.9629, 20.5937],
                        zoom: 4
                    });

                    map.on('load', () => {
                        addResult('✅ Map loaded successfully!', 'success');
                        // Hide loading spinner
                        const loadingDiv = document.querySelector('#map > div');
                        if (loadingDiv) {
                            loadingDiv.style.display = 'none';
                        }
                    });

                    map.on('error', (e) => {
                        addResult(`❌ Map error: ${e.error}`, 'error');
                    });

                } catch (error) {
                    addResult(`❌ Error creating map: ${error.message}`, 'error');
                }
            };
            script.onerror = () => {
                addResult('❌ Failed to load Mapbox GL JS', 'error');
            };
            document.head.appendChild(script);
        }

        // Auto-test on page load
        window.addEventListener('load', () => {
            addResult('Page loaded, ready to test map loading...', 'info');
            setTimeout(() => {
                testActualMap();
            }, 1000);
        });
    </script>
</body>
</html>
